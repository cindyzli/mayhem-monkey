import { useState, useRef, useEffect } from 'react';
import { Shield, X } from 'lucide-react';
import { TestPanel } from './TestPanel';
import { ResultsPanel } from './ResultsPanel';
import { motion } from 'motion/react';

export type Severity = 'critical' | 'high' | 'medium' | 'low';

export interface Vulnerability {
  id: string;
  title: string;
  severity: Severity;
  category: string;
  line: number;
  description: string;
  impact: string;
  recommendation: string;
  codeSnippet: string;
}

const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:8000';

/** Map a free-form severity string to one of the four allowed values. */
export function normalizeSeverity(s: string): Severity {
  const lower = (s || '').toLowerCase();
  if (lower.includes('critical')) return 'critical';
  if (lower.includes('high')) return 'high';
  if (lower.includes('low')) return 'low';
  return 'medium';
}

/**
 * Transform the raw JSON the Gemini router writes to results/scan_results.json
 * into the Vulnerability[] the ResultsPanel expects.
 */
export function transformResults(data: Record<string, unknown>): Vulnerability[] {
  // vulnerabilities format: { vulnerabilities: [{ severity, title, details: { description, codeSnippet, impact, recommendation } }] }
  if (Array.isArray(data.vulnerabilities)) {
    return (data.vulnerabilities as Record<string, unknown>[]).map((vuln, i) => {
      const details = vuln.details as Record<string, unknown> || {};
      return {
        id: String(i + 1),
        title: String(vuln.title || 'Vulnerability Found'),
        severity: normalizeSeverity(String(vuln.severity || 'medium')),
        category: String(vuln.category || 'Security'),
        line: 0,
        description: String(details.description || ''),
        impact: String(details.impact || ''),
        recommendation: String(details.recommendation || ''),
        codeSnippet: String(details.codeSnippet || ''),
      };
    });
  }

  // detailSections format: { detailSections: [...] }
  if (Array.isArray(data.detailSections)) {
    return (data.detailSections as Record<string, unknown>[]).map((section, i) => ({
      id: String(i + 1),
      title: String(section.vulnerabilityTitle || 'Vulnerability Found'),
      severity: normalizeSeverity(String(section.severity || 'medium')),
      category: String(section.category || 'Security'),
      line: 0,
      description: String(section.description || ''),
      impact: String(section.impact || ''),
      recommendation: String(section.recommendation || ''),
      codeSnippet: String(section.codeSnippet || ''),
    }));
  }

  // Multi-finding format: { findings: [...] }
  if (Array.isArray(data.findings)) {
    return (data.findings as Record<string, unknown>[]).map((f, i) => ({
      id: String(i + 1),
      title: String(f.title || 'Vulnerability Found'),
      severity: normalizeSeverity(String(f.severity || f.risk || 'medium')),
      category: String(f.type || f.category || 'Security'),
      line: 0,
      description: String(f.impact || f.description || ''),
      impact: String(f.impact || ''),
      recommendation: String(f.recommendation || ''),
      codeSnippet: String(f.evidence || f.repro_steps || ''),
    }));
  }

  // Single-result format: { result, evidence, risk, recommendation }
  const result = String(data.result || 'Scan complete');
  const evidence = String(data.evidence || '');
  const recommendation = String(data.recommendation || '');
  const risk = normalizeSeverity(String(data.risk || 'medium'));

  if (result.toLowerCase().includes('no vulnerabilit')) return [];

  return [{
    id: '1',
    title: 'Vulnerability Detected',
    severity: risk,
    category: 'Security',
    line: 0,
    description: result,
    impact: evidence,
    recommendation,
    codeSnippet: Array.isArray(data.repro_steps)
      ? (data.repro_steps as string[]).join('\n')
      : evidence,
  }];
}

export function VulnerabilityScanner() {
  const [isOpen, setIsOpen] = useState(true);
  const [isScanning, setIsScanning] = useState(false);
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [targetUrl, setTargetUrl] = useState('');
  const pollRef = useRef<ReturnType<typeof setInterval> | null>(null);
  const scannerStartedRef = useRef(false);
  const [selectedTests, setSelectedTests] = useState<string[]>([
    'sql-injection',
    'xss',
    'file-upload',
    'authentication',
    'encryption',
    'input-validation'
  ]);

  useEffect(() => {
    return () => {
      if (pollRef.current) {
        clearInterval(pollRef.current);
      }
    };
  }, []);

  const startScan = async () => {
    const url = targetUrl.trim();
    const requestInit: RequestInit | undefined = url
      ? {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url }),
      }
      : undefined;

    if (pollRef.current) {
      clearInterval(pollRef.current);
      pollRef.current = null;
    }
    scannerStartedRef.current = false;
    setIsScanning(true);
    setVulnerabilities([]);

    try {
      const res = await fetch(`${API_BASE}/start`, requestInit);

      if (!res.ok) {
        console.error('Failed to start scan:', await res.text());
        setIsScanning(false);
        return;
      }

      // Poll /scan/status every 3s until results are ready
      pollRef.current = setInterval(async () => {
        try {

          const statusRes = await fetch(`${API_BASE}/scan/status`);
          const status = await statusRes.json();
          if (status.running) {
            scannerStartedRef.current = true;
          }

          if (status.has_results) {
            // Results file exists â€” fetch and display
            if (pollRef.current) clearInterval(pollRef.current);

            const resultsRes = await fetch(`${API_BASE}/results`);
            const body = await resultsRes.json();

            if (body.status === 'complete' && body.data) {
              setVulnerabilities(transformResults(body.data));
            }
            setIsScanning(false);
            scannerStartedRef.current = false;
          } else if (status.running === false && scannerStartedRef.current) {
            // Scanner exited without writing results
            if (pollRef.current) clearInterval(pollRef.current);
            setIsScanning(false);
            scannerStartedRef.current = false;
          }
        } catch (err) {
          console.error('Poll error:', err);
        }
      }, 3000);
    } catch (err) {
      console.error('Network error:', err);
      setIsScanning(false);
    }
  };

  return (
    <>
      {/* Floating trigger button with dancing monkey */}
      <motion.button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-6 monkey-button right-6 text-white rounded-full p-4 shadow-[0_31.69px_63.38px_-15.211px_rgba(0,0,0,0.25)] transition-all hover:scale-110 z-[60]" style={{ background: 'linear-gradient(135deg, #155DFC 0%, #00267A 100%)' }}
        aria-label="Open vulnerability scanner"
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.95 }}
      >
        <motion.div
          className="text-3xl"
          animate={{
            rotate: [0, -5, 5, -5, 5, 0],
          }}
          transition={{
            duration: 1.2,
            repeat: Infinity,
            ease: "easeInOut"
          }}
        >
          <img src="/images/dancing_monkey_transparent.gif" alt="Dancing Monkey" className="w-20 h-20" />
        </motion.div>
      </motion.button>

      {/* Overlay backdrop */}
      {isOpen && (
        <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 animate-in fade-in duration-200">
          {/* Overlay panel */}
          <div className="fixed right-0 top-0 bottom-0 bg-gray-900 border-l border-gray-800 shadow-2xl animate-in slide-in-from-right duration-300 flex flex-col"
            style={{ width: '400px' }}>
            {/* Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-800 bg-gray-900/95 backdrop-blur">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-blue-600/20 rounded-lg">
                  <Shield className="w-6 h-6 text-blue-400" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white">Mayhem Monkey</h2>
                  <p className="text-sm text-gray-400">Vulnerability Scanner</p>
                </div>
              </div>
              <button
                onClick={() => setIsOpen(false)}
                className="p-2 hover:bg-gray-800 rounded-lg transition-colors"
                aria-label="Close scanner"
              >
                <X className="w-6 h-6 text-gray-400" />
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto"
              style={{ height: '400px' }}>
              <div className="p-6 space-y-6">
                {/* Target URL */}
                <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                  <label className="block text-sm font-medium text-gray-300 mb-2">Target URL</label>
                  <input
                    type="url"
                    value={targetUrl}
                    onChange={e => setTargetUrl(e.target.value)}
                    placeholder="https://example.com"
                    disabled={isScanning}
                    className="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50"
                  />
                </div>

                <TestPanel
                  selectedTests={selectedTests}
                  onTestsChange={setSelectedTests}
                  onStartScan={startScan}
                  isScanning={isScanning}
                  disabled={isScanning}
                />

                {/* Only show results when they arrive - nothing else */}
                {vulnerabilities.length > 0 && (
                  <ResultsPanel vulnerabilities={vulnerabilities} />
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
