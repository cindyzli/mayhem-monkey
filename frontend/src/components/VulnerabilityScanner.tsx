import { useState } from 'react';
import { Shield, X } from 'lucide-react';
import { TestPanel } from './TestPanel';
import { ResultsPanel } from './ResultsPanel';
import { ScanningProgress } from './ScanningProgress';
import { motion } from 'motion/react';

export type Severity = 'critical' | 'high' | 'medium' | 'low';

export interface Vulnerability {
  id: string;
  title: string;
  severity: Severity;
  category: string;
  line: number;
  description: string;
  impact: string;
  recommendation: string;
  codeSnippet: string;
}

export function VulnerabilityScanner() {
  const [isOpen, setIsOpen] = useState(true);
  const [isScanning, setIsScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [selectedTests, setSelectedTests] = useState<string[]>([
    'sql-injection',
    'xss',
    'file-upload',
    'authentication',
    'encryption',
    'input-validation'
  ]);

  const startScan = () => {
    setIsScanning(true);
    setScanProgress(0);
    setVulnerabilities([]);

    // Simulate scanning progress
    const interval = setInterval(() => {
      setScanProgress(prev => {
        if (prev >= 100) {
          clearInterval(interval);
          setIsScanning(false);
          generateVulnerabilities();
          return 100;
        }
        return prev + 10;
      });
    }, 300);
  };

  const generateVulnerabilities = () => {
    const mockVulnerabilities: Vulnerability[] = [
      {
        id: '1',
        title: 'SQL Injection Vulnerability',
        severity: 'critical',
        category: 'SQL Injection',
        line: 3,
        description: 'User input is directly concatenated into SQL query without sanitization or parameterization.',
        impact: 'Attackers can execute arbitrary SQL commands, potentially accessing, modifying, or deleting database contents.',
        recommendation: 'Use parameterized queries or prepared statements. Never concatenate user input directly into SQL queries.',
        codeSnippet: `const query = "SELECT * FROM users WHERE username = '" + username + "'";`
      },
      {
        id: '2',
        title: 'Cross-Site Scripting (XSS)',
        severity: 'high',
        category: 'XSS',
        line: 8,
        description: 'User data is rendered directly to the DOM using innerHTML without sanitization.',
        impact: 'Attackers can inject malicious scripts that execute in other users\' browsers, stealing credentials or performing actions on their behalf.',
        recommendation: 'Use textContent instead of innerHTML, or sanitize user input with a trusted library like DOMPurify.',
        codeSnippet: `document.getElementById('profile').innerHTML = userData.bio;`
      },
      {
        id: '3',
        title: 'Unrestricted File Upload',
        severity: 'high',
        category: 'File Upload',
        line: 12,
        description: 'File upload functionality does not validate file types or sizes.',
        impact: 'Attackers can upload malicious files (e.g., shell scripts, executables) that could compromise the server.',
        recommendation: 'Implement strict file type validation, size limits, and store uploaded files outside the web root with randomized names.',
        codeSnippet: `function uploadFile(file) {\n  saveToServer(file);\n}`
      },
      {
        id: '4',
        title: 'Weak Password Storage',
        severity: 'critical',
        category: 'Authentication',
        line: 3,
        description: 'Password appears to be stored or compared in plaintext.',
        impact: 'If the database is compromised, all user passwords are immediately exposed.',
        recommendation: 'Use bcrypt, argon2, or scrypt to hash passwords with a salt before storage. Never store plaintext passwords.',
        codeSnippet: `WHERE password = '" + password + "'`
      },
      {
        id: '5',
        title: 'Missing Input Validation',
        severity: 'medium',
        category: 'Input Validation',
        line: 2,
        description: 'Function parameters lack validation and sanitization.',
        impact: 'Unexpected input formats can cause application errors or be exploited for injection attacks.',
        recommendation: 'Validate all input parameters for type, format, and length. Reject invalid input early.',
        codeSnippet: `function authenticateUser(username, password) {`
      }
    ];

    setVulnerabilities(mockVulnerabilities);
  };

  return (
    <>
      {/* Floating trigger button with dancing monkey */}
      <motion.button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-6 right-6 bg-gradient-to-br from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-full p-4 shadow-2xl transition-all hover:scale-110 z-[60]"
        aria-label="Open vulnerability scanner"
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.95 }}
      >
        <motion.div
          className="text-3xl"
          animate={{
            rotate: [0, -10, 10, -10, 10, 0],
          }}
          transition={{
            duration: 0.8,
            repeat: Infinity,
            ease: "easeInOut"
          }}
        >
          üêµ
        </motion.div>
      </motion.button>

      {/* Overlay backdrop */}
      {isOpen && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 animate-in fade-in duration-200">
          {/* Overlay panel */}
          <div className="fixed right-0 top-0 bottom-0 w-full max-w-2xl bg-gray-900 border-l border-gray-800 shadow-2xl animate-in slide-in-from-right duration-300 flex flex-col">
            {/* Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-800 bg-gray-900/95 backdrop-blur">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-blue-600/20 rounded-lg">
                  <Shield className="w-6 h-6 text-blue-400" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white">Mayhem Monkey</h2>
                  <p className="text-sm text-gray-400">Vulnerability Scanner</p>
                </div>
              </div>
              <button
                onClick={() => setIsOpen(false)}
                className="p-2 hover:bg-gray-800 rounded-lg transition-colors"
                aria-label="Close scanner"
              >
                <X className="w-6 h-6 text-gray-400" />
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto">
              <div className="p-6 space-y-6">
                <TestPanel 
                  selectedTests={selectedTests}
                  onTestsChange={setSelectedTests}
                  onStartScan={startScan}
                  isScanning={isScanning}
                />

                {isScanning && (
                  <ScanningProgress progress={scanProgress} />
                )}

                {!isScanning && vulnerabilities.length > 0 && (
                  <ResultsPanel vulnerabilities={vulnerabilities} />
                )}

                {!isScanning && vulnerabilities.length === 0 && (
                  <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-8 text-center">
                    <Shield className="w-12 h-12 text-gray-600 mx-auto mb-3" />
                    <h3 className="text-lg font-medium text-gray-300 mb-2">Ready to Scan</h3>
                    <p className="text-gray-500 text-sm">
                      Select the tests you want to run and click "Start Scan" to analyze your code for vulnerabilities.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
}