import { useState } from 'react';
import { Shield, X } from 'lucide-react';
import { TestPanel } from './TestPanel';
import { ResultsPanel } from './ResultsPanel';
import { ScanningProgress } from './ScanningProgress';
import type { Vulnerability, Severity } from './VulnerabilityScanner';
import { motion } from 'motion/react';

export function VulnerabilityScannerWindow() {
  const [isScanning, setIsScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [isOpen, setIsOpen] = useState(true);
  const [selectedTests, setSelectedTests] = useState<string[]>([
    'sql-injection',
    'xss',
    'file-upload',
    'authentication',
    'encryption',
    'input-validation'
  ]);

  const startScan = () => {
    setIsScanning(true);
    setScanProgress(0);
    setVulnerabilities([]);

    // Simulate scanning progress
    const interval = setInterval(() => {
      setScanProgress(prev => {
        if (prev >= 100) {
          clearInterval(interval);
          setIsScanning(false);
          generateVulnerabilities();
          return 100;
        }
        return prev + 10;
      });
    }, 300);
  };

  const generateVulnerabilities = () => {
    const mockVulnerabilities: Vulnerability[] = [
      {
        id: '1',
        title: 'SQL Injection Vulnerability',
        severity: 'critical' as Severity,
        category: 'SQL Injection',
        line: 3,
        description: 'User input is directly concatenated into SQL query without sanitization or parameterization.',
        impact: 'Attackers can execute arbitrary SQL commands, potentially accessing, modifying, or deleting database contents.',
        recommendation: 'Use parameterized queries or prepared statements. Never concatenate user input directly into SQL queries.',
        codeSnippet: `const query = "SELECT * FROM users WHERE username = '" + username + "'";`
      },
      {
        id: '2',
        title: 'Cross-Site Scripting (XSS)',
        severity: 'high' as Severity,
        category: 'XSS',
        line: 8,
        description: 'User data is rendered directly to the DOM using innerHTML without sanitization.',
        impact: 'Attackers can inject malicious scripts that execute in other users\' browsers, stealing credentials or performing actions on their behalf.',
        recommendation: 'Use textContent instead of innerHTML, or sanitize user input with a trusted library like DOMPurify.',
        codeSnippet: `document.getElementById('profile').innerHTML = userData.bio;`
      },
      {
        id: '3',
        title: 'Insecure Authentication',
        severity: 'high' as Severity,
        category: 'Authentication',
        line: 15,
        description: 'Weak password policy and lack of multi-factor authentication.',
        impact: 'Accounts can be compromised through brute force or credential stuffing attacks.',
        recommendation: 'Implement strong password requirements and add MFA support.',
        codeSnippet: `if (password === storedPassword) { login(); }`
      }
    ];

    setVulnerabilities(mockVulnerabilities);
  };

  const handleClose = () => {
    window.electronAPI?.closeScanner();
  };

  return (
    <>
    {/* Floating trigger button with dancing monkey */}
      <motion.button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-6 monkey-button right-6 text-white rounded-full p-4 shadow-[0_31.69px_63.38px_-15.211px_rgba(0,0,0,0.25)] transition-all hover:scale-110 z-[60]" style={{ background: 'linear-gradient(135deg, #155DFC 0%, #00267A 100%)' }}
        aria-label="Open vulnerability scanner"
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.95 }}
      >
        <motion.div
          className="text-3xl"
          animate={{
            rotate: [0, -5, 5, -5, 5, 0],
          }}
          transition={{
            duration: 1.2,
            repeat: Infinity,
            ease: "easeInOut"
          }}
        >
          <img src="/images/dancing_monkey_transparent.gif" alt="Dancing Monkey" className="w-20 h-20" />
        </motion.div>
      </motion.button>
    <div className="w-full bg-gray-900 flex flex-col"
    style={{ height: '830px' }}>
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-800 bg-gray-900/95 backdrop-blur">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-blue-600/20 rounded-lg">
            <Shield className="w-5 h-5 text-blue-400" />
          </div>
          <div>
            <h2 className="text-lg font-bold text-white">Mayhem Monkey</h2>
            <p className="text-xs text-gray-400">Vulnerability Scanner</p>
          </div>
        </div>
        <button
          onClick={handleClose}
          className="p-2 hover:bg-gray-800 rounded-lg transition-colors"
          aria-label="Close scanner"
        >
          <X className="w-5 h-5 text-gray-400" />
        </button>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">
        <div className="p-4 space-y-4">
          <TestPanel 
            selectedTests={selectedTests}
            onTestsChange={setSelectedTests}
            onStartScan={startScan}
            isScanning={isScanning}
          />

          {isScanning && (
            <ScanningProgress progress={scanProgress} />
          )}

          {!isScanning && vulnerabilities.length > 0 && (
            <ResultsPanel vulnerabilities={vulnerabilities} />
          )}

          {!isScanning && vulnerabilities.length === 0 && (
            <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-6 text-center">
              <Shield className="w-10 h-10 text-gray-600 mx-auto mb-3" />
              <h3 className="text-base font-medium text-gray-300 mb-2">Ready to Scan</h3>
              <p className="text-gray-500 text-sm">
                Select tests and click "Start Scan" to analyze your code.
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  </>
  );
}
